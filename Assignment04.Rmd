---
title: "Assignment04"
author: "Megan Willis-Jackson, Claire Wang, Ignacio Lafuente"
date: "2/17/2022"
output: html_document
---

# Load Libraries

```{r, message=F, echo=F, warning=F}
library(sf)
library(tigris)
library(tidyverse)
library(osmdata)
library(here)
library(tidytransit)
options(java.parameters = "-Xmx5G")
library(r5r)
library(lubridate)


```


# Download OSM data

```{r, message=F, warning=F, results='hide'}
# Load the MSA boundaries
boundary <- core_based_statistical_areas() %>% 
  filter(GEOID == "41940")

# Define a bounding box containing the MSA
sanjose_bbox <- st_bbox(boundary)

q <- opq(bbox = sanjose_bbox) %>% # create a query
  add_osm_feature(key = 'highway') %>% # request only road data
  osmdata_xml(file = 'existing/networks/streets.osm') # download osm file

```

# Zone Centroids

```{r, message=F, error=F, warning=F, results='hide'}

centroids <- here("zones",
                  "zones_sanjose2.geojson") %>%
  st_read() %>%
  st_centroid() %>%
  st_transform("WGS84") %>%
  rename(id = GEOID)

st_write(centroids, here("zones", "centroids.geojson"))

sj_tracts <- here("zones",
                  "zones_sanjose2.geojson") %>%
  st_read() %>%
  st_transform("WGS84")


ggplot(sj_tracts) +
  geom_sf() +
  geom_sf(data = centroids)

```

# Load SJ GTFS Data


```{r}
current_gtfs <- here("existing",
                     "networks",
                     "gtfs_vta.zip") %>%
  read_gtfs()


```

# Generate skims

```{r, message=F, warning=F, results='hide'}
existing_core <- here("existing",
                      "networks") %>%
  setup_r5(verbose = FALSE)

```

```{r, message=F, warning=F, results='hide'}

car_skim_existing <- travel_time_matrix(existing_core, 
                     origins = centroids,
                     destinations = centroids,
                     mode = "CAR")

walk_skim_existing <- travel_time_matrix(existing_core, 
                      origins = centroids,
                      destinations = centroids,
                      mode = "WALK")

bike_skim_existing <- travel_time_matrix(existing_core, 
                      origins = centroids,
                      destinations = centroids,
                      mode = "BICYCLE")

transit_skim_existing <- travel_time_matrix(existing_core, 
                         origins = centroids,
                         destinations = centroids,
                         mode = "TRANSIT",
                         departure_datetime = ymd_hm("2022-02-14 08:30"),
                         breakdown = TRUE)


stop_r5()

```

# Combine Files

```{r, message=F, warning=F, results='hide'}
transit_skim_existing <- transit_skim_existing %>%
  filter(n_rides > 0)

car_skim_existing <- car_skim_existing %>%
  rename(car_time = travel_time) 

transit_skim_existing <- transit_skim_existing %>%
  rename(transit_time = travel_time) 

walk_skim_existing <- walk_skim_existing %>%
  rename(walk_time = travel_time)

bike_skim_existing <- bike_skim_existing %>%
  rename(bike_time = travel_time)

```


# Save Existing Skims

```{r}
write_csv(walk_bike_skim_existing, here("existing/data/walk_bike_skims.csv"))
write_csv(transit_skim_existing, here("existing/data/transit_skim.csv"))
write_csv(car_skim_existing, here("existing/data/car_skim.csv"))


```

# Save Alternative Skims (no change to Existing)

```{r}
write_csv(walk_bike_skim_existing, here("alternative/data/walk_bike_skims.csv"))
write_csv(transit_skim_existing, here("alternative/data/transit_skim.csv"))
write_csv(car_skim_existing, here("alternative/data/car_skim.csv"))


```


# Create Isochrones

```{r, message=F, warning=F}

walk_bike_skim_existing <- read_csv(here("existing/data/walk_bike_skims.csv"))
transit_skim_existing <- read_csv(here("existing/data/transit_skim.csv"))
car_skim_existing <- read_csv(here("existing/data/car_skim.csv"))

```

```{r}
tt_wide <- car_skim_existing %>%
  pivot_wider(names_from = fromId, 
              names_prefix = "from", values_from = car_time) %>%
  rename(id = toId) %>% 
  merge(sj_tracts) %>%
  replace(is.na(.), 999) %>%
  rowwise() %>%
  mutate(from_any = min(c_across(starts_with("from")), na.rm = TRUE))


st_geometry(tt_wide) <- "geometry"

ggplot() +
  geom_sf(data = tt_wide, 
          aes(fill = from_any), 
          color = NA) +
  geom_sf(alpha = 0.5) +
  scale_fill_gradient2(low = "green", mid = "yellow", high = "red", 
                       midpoint = 30,
        name = "Transit Travel\ntime to the\nnearest school\n(minutes)") +
  coord_sf(crs = "WGS84") 


```




















